#### 专题二 大话Nodejs变化 直播课笔记

**http协议那些事儿**
1. http请求模型
> client -> server
> client <- server
>（客户端只能发送请求接收响应，服务端只能接受请求发送响应）

* http 协议是一种无状态的，维持不住当前的通信状态，请求响应是一次操作，结束后就结束了，每次都是独立的
* http 是基于tcp的，到Http3的时候变成基于udp了
2. **浏览器从输入一个url到页面显示出来都发生了什么？一道经典的面试题**
* 输入网址并回车 --> 解析域名 --> 浏览器发送http请求 --> 服务器处理请求 --> 服务器返回html响应 --> 浏览器处理html页面 --> 继续请求其他资源
(用户在浏览器输入一个网址按下回车，首先浏览器确保浏览器是通的，网络分为局域网和互联网，浏览器可以跨过防火墙的边界到达互联网上，互联网上所有的网址都要有一个Ip，在链路层上要识别这些服务就需要给它一个编码（就是ip），现在主要使用的是ipv4(是由一个整型数据组成的)，国家目前在推行ipv6，ipv6可以提供更多的ip地址，域名相当于谁的家，ip地址相当于门牌号码，DNS就是用来转换域名和Ip地址的，拿到ip地址的服务器之后，浏览器就开始上路了，中间会经过很多层路由，找到服务器后，服务器把浏览器需要的数据返回给它，然后浏览器拿到数据后，再经过一系列路由，回到用户面前，这一阶段是浏览器在网络层面的工作，在用户看到页面之前，浏览器还需要做很多资源整合和渲染，用户才能看到花花绿绿的页面)

* ipv4是第四版的ip协议
* dns是用来转换ip和域名的，常用的是互联网的DNS，但是在局域网也可以配置DNS
* 一个Ip地址可以有多个服务器

3. **什么是http协议？**http是超文本传输协议，从www服务器传输到本地浏览器的一种传输协议，网站是基于http协议的，例如网站的图片、css、js等都是基于http协议进行传输的；HTTP协议是从客户机到服务器的请求和从服务器到客户机的响应进行约束和规范。
* ftp是文件传输协议；ssh协议是远程登录linux系统用的加密协议；

4. **了解TCP/IP协议栈**（四层协议或五层协议 事实上的协议）
* 1 应用层：为用户提供所需要的各种服务，例如：HTTP、FTP、DNS、SMTP等。
* 2 传输层：为应用层实体提供端到端的通信功能，保证数据包的顺序传送及数据的完整性。该层定义了两个主要的协议：传输控制协议（TCP）和用户数据协议（UDP）。
* 3 网络层：主要解决主机到主机的通信问题，IP协议是国际互联网层最重要的协议。
* 4 网络接口层：负责监视数据在主机和网络之间的交换。

* [http协议与tcp协议简单理解](https://www.cnblogs.com/dingjiaoyang/p/5326544.html "http协议与tcp协议简单理解")

5. **在TCP/IP协议栈中的位置**
* 目前普遍应用版本是http1.1
* 正在逐步向http 2迁移
* http默认端口号为80
* https默认端口号为443
* https有加密功能

6. **HTTP的工作工程**
* 一次HTTP操作称为一个**事务**，其工作过程可分为四步：
* 1) 首先客户机与服务器需要建立连接。只要单机某个超级链接，HTTP的工作开始。（TCP层面的）
* 2) 建立连接后，客户机发送一个请求给服务器，请求方式的格式为：统计资源标识符（URL）、协议版本号，后边是MIME信息包括请求修饰符、客户机信息和可能的内容（HTTP层面的request）
* 3) 服务器接到请求后，给予相应的响应信息，其格式为一个状态行，包括信息的协议版本号、一个成功或错误的代码，后面是MIME信息包括服务器信息、实体信息和可能的内容（HTTP层面的response）
* 4) 客户端接收服务器所返回的信息通过浏览器显示在用户的显示屏上，然后客户机与服务器断开连接。
* 5) 如果在以上过程中的某一步出现错误。那么产生错误的信息将返回到客户端，有显示屏输出，对于用户来说，这些过程是由HTTP自己完成的，用户只要用鼠标点击，等待信息显示就可以了

#### 请求和响应
- HTTP请求组成：请求行、消息报头、请求正文
- HTTP响应组成：状态行、消息报头、响应正文
- 请求行组成：以一个方法符号开头，后面跟着请求的URI和协议的版本
- 状态行组成：服务器http协议的版本，服务器发回的响应状态代码和状态代码的文办描述

7. **HTTP请求方法**
- get post head put delete trace connect options
- 面试点get和post的区别
- 请求报头详解：见课件PPT

8. **HTTP状态码**

9. **cookies与session**
* Cookies是保存在客户端的小段文本，随客户端点每一个请求发送该url下的所有cookies到服务器端（存在安全问题，别人获取到cookie，就等于拿到了用户的身份，可以对网站进行攻击）
* Session则保存在服务器端，通过唯一的值sessionID来区别每一个用户。sessionID随每个连接请求发送到服务器，服务器根据sessionID来识别客户端，再通过session的key获取session值。（session是服务器上的小型数据库）

10. **浏览器缓存机制**，缓存会根据请求保存输出内容的副本，例如HTML页面，图片，文件，当下一个请求来到的时候，如果是相同的URL，缓存直接使用副本响应访问请求，而不是向源服务器再次发送请求。
- 缓存的优点：减少响应延迟，减少网络带宽消耗
- 浏览器在计算机磁盘是有一块专门的缓存空间
* 缓存策略有两种：强缓存和协商缓存
- 强制缓存，服务器通知浏览器一个缓存时间，在缓存时间内，下次请求，直接用缓存，不在时间内，执行协商缓存策略
- 协商缓存，将缓存信息中的Etag和Last-Modified通过请求发送给服务器，有服务器校验，返回304状态码时，浏览器直接使用缓存。
- Etag/If-None-Match策略
- Last-Modified/If-Modified-Since策略

304本地跳转

11. **HTTPS协议分析**
- HTTPS协议的安全性由SSL协议实现，当前使用的TLS协议1.2版本包含了四个核心子协议：握手协议，密钥配置切换协议，应用数据协议及报警协议
- 数字证书：数字证书是互联网通信中标识双方身份信息的数字文件，有CA签发
- CA: CA(certification authority)是数字证书的签发机构。作为权威机构，其审核申请者身份后签发数字证书，这样我们只需要校验数字证书即可确定对方的真是身份。
- HTTPS协议、SSL协议、TLS协议、握手协议的关系，HTTPS即是HTTP over SSL,可以理解为基于SSL的HTTP协议。HTTPS协议安全是由SSL协议实现的。
- SSL协议是一种记录协议，扩展性良好，可以很方便的添加子协议，而握手协议便是SSL协议的一个子协议。
- TLS协议是SSL协议的后续版本，本文中涉及的SSL协议默认是TLS协议1.2版本
- https是需要配证书的，这个证书是由CA签发的，如果要使用Https需要先申请证书，然后配置到nginx服务器上，然后才能使用

12. **HTTP2协议分析**，与HTTP1的区别
* 使用二进制格式传输，更高效，更紧凑
* 对报头压缩，降低开销
* 多路复用，一个网络连接实现并行请求
* 服务器主动推送，减少请求的延迟(例子：ajax是页面无刷新的，实际上在后台有脚本不断地向服务器提交请求，服务器再把数据响应回来，这样比较耗带宽，http2可以不再使用ajax了，因为服务器拿到数据后主动推送回来，以后Http2发展起来后，ajax估计就不用了)
* 默认使用加密
* 目前使用http2的网站有ke.qq.com(腾讯课堂)、google是最早支持http2的

13. **HTTP2的伪头字段**，伪头字段是http2内置的几个特殊的以“：”开始的key，用于替代http/1.x中请求行/响应行中的信息，比如请求方法，响应状态码等
* :method 目标URL模式部分（请求）
* :scheme 目标URL模式部分（请求）
* :authority 目标URL认证部分（请求）
* :path 目标URL的路径和查询部分（绝对路径产生式和一个跟着“？”字符的查询产生式）（请求）
* :status 响应头中的HTTP状态码部分（响应）
* 请求头里面把自定义的头字段，前面加一个冒号，这样可以和默认的头字段做区分

14. **HTTP3**，将会是一种全新的WEB协议,由Google提出的，HTTP3与HTTP1.1和HTTP2没有直接的关系，不是HTTP2的扩展；HTTP3的底层协议是基于UDP的

15. **http与反向代理**
* 网络根据规模和拓扑结构来划分为：局域网（家里或公司的）、广域网、互联网
* 正向代理的作用有：监控、科学上网（是局域网内往局域网外搞事情）
* 什么是代理，什么又是反向代理？
> 代理，自己不方便直接去做的事情让别人去做，举例如：代购（局域网内向局域网外搞事情）
> 反向代理，收到请求之后，先分析URL，根据URL的规则，转发到对应服务器上。
> **反向代理的用途**：加密和ssl加速，负载均衡，缓存静态内容，压缩，减速上传，安全，外网发布
* 为什么要使用反向代理？
* 都有哪些反向代理服务器？
> ngnix
* 网络分为：局域网、广域网、互联网

16. 让nginx跑起来
* 1) nginx.org网站去下载，下载stable version版本下面的
* 2) 利用yum的源安装nginx，这个方法推荐使用，或者下载rpm包进行安装
* 3) 配置，upstream web_crm(自己定义的块名字)定义转发规则
```
upstream web_crm {
    server 127.0.0.1:8080
}
```


#### 4.5 大规模Node.js项目框架与优化直播课
* 服务端渲染
* 异步IO的好处
- 前端通过异步IO可以消除UI堵塞
- 假设请求资源A的时间为M，请求资源B的时间为N，那么同步的请求耗时为M+N，如果采用异步方式占用时间为Max(M,N)
- 随着业务的复杂，会引入分布式系统，时间会线性的增加，M+N+...和Max(M,N...)，这会放大同步和异步之间的差异。
- I/O是昂贵的，分布式I/O是更昂贵的
- nodejs适用于IO密集型（大量的数据读写）不适用CPU密集型（大量的数据计算）

* node对异步IO的实现
- 完美的异步IO应该是应用程序发起非阻塞调用，无需通过遍历或事件循环等方式轮询

* 几个特殊的API
- setTimeout和setInterval线程池不参与libuv
- process.nextTick()实现类似setTimeout(function(){},0);每次调用放入队列中，在下一轮循环中取出
- setImmediate()比process.nextTick()优先级低
- node如何实现一个sleep？

* 函数式编程在node中的应用
- 高阶函数：可以将函数作为输入或者返回值，形成一种后续传递风格的结果接受方式，而非单一的返回值形式。后续传递风格的程序将函数业务重点从返回值传递到回调函数中。
```
app.use(function(){//todo})
var emitter = new events.EventEmitter;
emitter.on(function(){//......todo})
```
- 偏函数：指定部分参数产生一个新的定制函数的形式就是偏函数。node中异步编程非常常见，我们通过哨兵变量会很容易造成业务的混乱。underscore, after变量。

* V8垃圾回收机制
* 常见的内存泄漏问题
- 无限制增长的数组
- 无限制设置属性和值
- 大循环，无GC机会

* system.js万能模块加载器

* **容错远大于业务！！！**
* js是解释型语言
* node 核心 libuv
协程


